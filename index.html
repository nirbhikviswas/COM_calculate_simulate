<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Center of Mass 3D Calculator & Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-color: #111827;
            --text-color: #e5e7eb;
            --text-muted-color: #9ca3af;
            --panel-bg: rgba(31, 41, 55, 0.5);
            --panel-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(17, 24, 39, 0.8);
            --input-border: #374151;
            --input-focus-border: #60a5fa;
            --input-focus-shadow: rgba(96, 165, 250, 0.5);
            --header-gradient-from: #d1d5db;
            --header-gradient-via: #ffffff;
            --header-gradient-to: #60a5fa;
            --tab-active-color: #60a5fa;
            --result-box-bg: rgba(17, 24, 39, 0.7);
            --com-result-color: #4ade80;
            --error-color: #f87171;
            --warning-color: #facc15;
            --btn-remove-color: #f87171;
            --btn-remove-hover: #fca5a5;
        }

        .light-theme {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --text-muted-color: #4b5563;
            --panel-bg: rgba(255, 255, 255, 0.7);
            --panel-border: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --input-focus-border: #3b82f6;
            --input-focus-shadow: rgba(59, 130, 246, 0.4);
            --header-gradient-from: #374151;
            --header-gradient-via: #111827;
            --header-gradient-to: #3b82f6;
            --tab-active-color: #2563eb;
            --result-box-bg: #f9fafb;
            --com-result-color: #166534;
            --error-color: #dc2626;
            --warning-color: #d97706;
            --btn-remove-color: #ef4444;
            --btn-remove-hover: #dc2626;
        }

        /* --- Base Styles using Variables --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark-theme-gradient {
            background-image: 
                radial-gradient(at 20% 20%, hsla(212,96%,25%,0.3) 0px, transparent 50%),
                radial-gradient(at 80% 80%, hsla(280,96%,25%,0.2) 0px, transparent 50%);
        }

        .panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--panel-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .btn { transition: all 0.3s ease; position: relative; overflow: hidden; border: 1px solid transparent; font-weight: 600; }
        .btn:after { content: ''; position: absolute; top: 50%; left: 50%; width: 5px; height: 5px; background: rgba(255, 255, 255, 0.5); opacity: 0; border-radius: 100%; transform: scale(1, 1) translate(-50%, -50%); transform-origin: 50% 50%; }
        .btn:focus:not(:active)::after { animation: ripple 1s ease-out; }
        .btn-blue { background: linear-gradient(145deg, #1e40af, #3b82f6); border-color: #60a5fa; }
        .btn-green { background: linear-gradient(145deg, #15803d, #22c55e); border-color: #4ade80; }
        .btn-red { background: linear-gradient(145deg, #b91c1c, #ef4444); border-color: #f87171; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 0 10px 0 rgba(147, 197, 253, 0.5), 0 0 20px 0 rgba(147, 197, 253, 0.3); }
        .btn-red:hover { box-shadow: 0 0 10px 0 rgba(239, 68, 68, 0.5), 0 0 20px 0 rgba(239, 68, 68, 0.3); }
        .btn-green:hover { box-shadow: 0 0 10px 0 rgba(34, 197, 94, 0.5), 0 0 20px 0 rgba(34, 197, 94, 0.3); }
        .btn:active { transform: translateY(-2px) scale(0.98); }
        @keyframes ripple { 0% { transform: scale(0, 0); opacity: 1; } 20% { transform: scale(25, 25); opacity: 1; } 100% { opacity: 0; transform: scale(40, 40); } }

        .tech-input { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-color); transition: all 0.3s ease; }
        .tech-input::placeholder { color: var(--text-muted-color); }
        .tech-input:focus { outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 10px 0 var(--input-focus-shadow); }
        
        .tab-btn { transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; color: var(--text-muted-color); }
        .tab-btn:hover { color: var(--text-color); }
        .tab-btn.active { color: var(--tab-active-color); border-bottom-color: var(--tab-active-color); text-shadow: 0 0 5px var(--tab-active-color); }
        
        .result-box { background: var(--result-box-bg); border: 1px solid var(--input-border); }
        .header-text { color: var(--header-gradient-from); background-image: linear-gradient(to right, var(--header-gradient-from), var(--header-gradient-via), var(--header-gradient-to)); }
        
        .com-result-text { color: var(--com-result-color); }
        .error-text { color: var(--error-color); }
        .warning-text { color: var(--warning-color); }
        .btn-remove-text { color: var(--btn-remove-color); }
        .btn-remove-text:hover { color: var(--btn-remove-hover); }

    </style>
</head>
<body class="dark-theme-gradient">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl relative">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text header-text animate-pulse">Center of Mass 3D Simulator</h1>
            <p class="mt-2 text-lg" style="color: var(--text-muted-color);">Precision calculations meets interactive 3D visualization.</p>
        </header>

        <div class="absolute top-4 right-4 flex space-x-2 bg-gray-800/50 p-1 rounded-full border border-gray-700/50">
            <button id="theme-light-btn" class="p-2 rounded-full text-gray-400 hover:bg-gray-700 hover:text-yellow-300 focus:outline-none" title="Switch to Light Mode">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            </button>
            <button id="theme-dark-btn" class="p-2 rounded-full text-gray-400 hover:bg-gray-700 hover:text-blue-300 focus:outline-none" title="Switch to Dark Mode">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </div>

        <div id="main-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Left Column: Calculators -->
            <div class="panel p-6 rounded-2xl">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2" style="border-color: var(--input-border); color: var(--text-color);">Calculators</h2>
                <div class="mb-4" style="border-bottom: 1px solid var(--input-border);">
                    <nav class="flex space-x-4" aria-label="Tabs">
                        <button id="tab-symbolic" class="tab-btn active px-3 py-2 text-sm font-medium" onclick="showTab('symbolic')">Symbolic</button>
                        <button id="tab-numerical" class="tab-btn px-3 py-2 text-sm font-medium" onclick="showTab('numerical')">Numerical & Sim</button>
                    </nav>
                </div>

                <div id="symbolic-calculator" class="calculator-content">
                    <div class="space-y-4">
                         <!-- Symbolic Inputs -->
                        <div><label for="symbolic-masses" class="block text-sm font-medium" style="color: var(--text-muted-color);">Masses (e.g., m1, m2)</label><input type="text" id="symbolic-masses" class="tech-input mt-1 block w-full px-3 py-2 rounded-md shadow-sm sm:text-sm" placeholder="m1, m2, m3"></div>
                        <div><label for="symbolic-x" class="block text-sm font-medium" style="color: var(--text-muted-color);">X-Positions (e.g., x1, x2)</label><input type="text" id="symbolic-x" class="tech-input mt-1 block w-full px-3 py-2 rounded-md shadow-sm sm:text-sm" placeholder="x1, x2, x3"></div>
                        <div><label for="symbolic-y" class="block text-sm font-medium" style="color: var(--text-muted-color);">Y-Positions (e.g., y1, y2)</label><input type="text" id="symbolic-y" class="tech-input mt-1 block w-full px-3 py-2 rounded-md shadow-sm sm:text-sm" placeholder="y1, y2, y3"></div>
                        <div><label for="symbolic-z" class="block text-sm font-medium" style="color: var(--text-muted-color);">Z-Positions (e.g., z1, z2)</label><input type="text" id="symbolic-z" class="tech-input mt-1 block w-full px-3 py-2 rounded-md shadow-sm sm:text-sm" placeholder="z1, z2, z3"></div>
                        <button onclick="calculateSymbolic()" class="w-full btn btn-blue text-white py-2 px-4 rounded-md">Calculate</button>
                        <div id="symbolic-result" class="mt-4 p-4 result-box rounded-md break-words min-h-[100px]" style="color: var(--text-color);">Your symbolic result will appear here.</div>
                    </div>
                </div>

                <div id="numerical-calculator" class="calculator-content hidden">
                     <div id="numerical-inputs" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
                     <div class="grid grid-cols-3 gap-2 mt-4">
                        <button onclick="addMassInput()" class="btn btn-green text-white py-2 px-4 rounded-md">Add Mass</button>
                        <button onclick="calculateNumerical()" class="btn btn-blue text-white py-2 px-4 rounded-md col-span-2">Calculate & Simulate</button>
                        <button onclick="resetNumerical()" class="btn btn-red text-white py-2 px-4 rounded-md col-span-3 mt-2">Reset All</button>
                     </div>
                      <div id="numerical-result" class="mt-4 p-4 result-box rounded-md min-h-[100px]" style="color: var(--text-color);">Your numerical result will appear here.</div>
                </div>
            </div>

            <!-- Right Column: 3D Simulation -->
            <div id="simulation-panel" class="panel p-6 rounded-2xl">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2" style="border-color: var(--input-border); color: var(--text-color);">Interactive 3D Simulation</h2>
                <div id="simulation-container" class="relative w-full aspect-square bg-gray-900 rounded-lg overflow-hidden" style="border: 1px solid var(--input-border);">
                    <div id="axis-legend" class="absolute top-2 left-2 text-xs p-2 rounded" style="background-color: rgba(0,0,0,0.2); color: var(--text-color); font-weight: 500;">
                        <div class="flex items-center space-x-2"><div class="w-3 h-1" style="background-color: #dc2626;"></div><span>X-Axis</span></div>
                        <div class="flex items-center space-x-2 mt-1"><div class="w-3 h-1" style="background-color: #22c55e;"></div><span>Y-Axis</span></div>
                        <div class="flex items-center space-x-2 mt-1"><div class="w-3 h-1" style="background-color: #3b82f6;"></div><span>Z-Axis</span></div>
                    </div>
                    <div id="axis-helper-container" class="absolute bottom-2 left-2 w-24 h-24 pointer-events-none"></div>
                    <div class="absolute bottom-2 right-3 text-xs pointer-events-none opacity-70" style="color: var(--text-muted-color);">B24450, IITMandi</div>
                </div>
            </div>
        </div>
    </div>

<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
<script type="importmap">
  { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    window.showTab = showTab;
    window.calculateSymbolic = calculateSymbolic;
    window.addMassInput = addMassInput;
    window.removeMassInput = removeMassInput;
    window.calculateNumerical = calculateNumerical;
    window.resetNumerical = resetNumerical;

    function showTab(tabName) {
        // Handle tab content and button styling
        document.querySelectorAll('.calculator-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`${tabName}-calculator`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Handle visibility of the simulation panel
        const mainGrid = document.getElementById('main-grid');
        const simulationPanel = document.getElementById('simulation-panel');

        if (tabName === 'symbolic') {
            simulationPanel.classList.add('hidden');
            mainGrid.classList.remove('lg:grid-cols-2');
            mainGrid.classList.add('lg:grid-cols-1');
        } else {
            simulationPanel.classList.remove('hidden');
            mainGrid.classList.remove('lg:grid-cols-1');
            mainGrid.classList.add('lg:grid-cols-2');
        }
    }

    function calculateSymbolic() {
        const masses = document.getElementById('symbolic-masses').value.split(',').map(s => s.trim()).filter(Boolean);
        const xs = document.getElementById('symbolic-x').value.split(',').map(s => s.trim()).filter(Boolean);
        const ys = document.getElementById('symbolic-y').value.split(',').map(s => s.trim()).filter(Boolean);
        const zs = document.getElementById('symbolic-z').value.split(',').map(s => s.trim()).filter(Boolean);
        const resultDiv = document.getElementById('symbolic-result');

        if (![masses, xs, ys, zs].every(arr => arr.length > 0) || ![xs, ys, zs].every(arr => arr.length === masses.length)) {
             resultDiv.innerHTML = `<p class="error-text">Error: The number of masses and positions in each coordinate must be equal and non-empty.</p>`;
            return;
        }

        const totalMass = masses.join(' + ');
        const xNum = masses.map((m, i) => `${m}*${xs[i]}`).join(' + ');
        const yNum = masses.map((m, i) => `${m}*${ys[i]}`).join(' + ');
        const zNum = masses.map((m, i) => `${m}*${zs[i]}`).join(' + ');

        resultDiv.innerHTML = `<p><strong style="color:var(--tab-active-color)">Total Mass (M):</strong> ${totalMass}</p><p class="mt-2"><strong style="color:var(--tab-active-color)">Center of Mass (X,Y,Z):</strong></p><ul class="list-none ml-2 mt-1 space-y-1 font-mono text-sm"><li><span style="color:var(--text-muted-color)">X =</span> (${xNum}) / (${totalMass})</li><li><span style="color:var(--text-muted-color)">Y =</span> (${yNum}) / (${totalMass})</li><li><span style="color:var(--text-muted-color)">Z =</span> (${zNum}) / (${totalMass})</li></ul>`;
    }

    let massInputCount = 0;
    function addMassInput(mass = '', x = '', y = '', z = '', color = '#3b82f6') {
        massInputCount++;
        const container = document.getElementById('numerical-inputs');
        const div = document.createElement('div');
        div.className = 'p-3 rounded-lg input-group-container';
        div.style.border = '1px solid var(--input-border)';
        div.style.backgroundColor = 'rgba(17, 24, 39, 0.3)';
        div.id = `mass-group-${massInputCount}`;
        div.innerHTML = `<div class="flex justify-between items-center mb-2"><span class="font-semibold" style="color:var(--text-color);">Mass ${massInputCount}</span><button onclick="removeMassInput(${massInputCount})" class="btn-remove-text text-xs font-semibold uppercase">Remove</button></div><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-2"><input type="number" step="any" placeholder="Mass (kg)" class="mass w-full px-2 py-1 rounded-md tech-input" value="${mass}"><input type="number" step="any" placeholder="X (m)" class="pos-x w-full px-2 py-1 rounded-md tech-input" value="${x}"><input type="number" step="any" placeholder="Y (m)" class="pos-y w-full px-2 py-1 rounded-md tech-input" value="${y}"><input type="number" step="any" placeholder="Z (m)" class="pos-z w-full px-2 py-1 rounded-md tech-input" value="${z}"><input type="color" title="Mass Color" class="mass-color w-full h-9 p-1 rounded-md tech-input" value="${color}"></div>`;
        container.appendChild(div);
    }

    function removeMassInput(id) { document.getElementById(`mass-group-${id}`).remove(); }
    
    function calculateNumerical() {
        const inputs = document.querySelectorAll('.input-group-container');
        const resultDiv = document.getElementById('numerical-result');
        let totalMass = 0, mx = 0, my = 0, mz = 0, valid = true, isColorError = false;
        const massesData = [];

        if (inputs.length === 0) {
             resultDiv.innerHTML = `<p class="error-text">Please add at least one mass.</p>`;
             updateSimulation([], null); return;
        }

        inputs.forEach(group => {
            const mass = parseFloat(group.querySelector('.mass').value); const x = parseFloat(group.querySelector('.pos-x').value); const y = parseFloat(group.querySelector('.pos-y').value); const z = parseFloat(group.querySelector('.pos-z').value);
            const color = group.querySelector('.mass-color').value;
            const r = parseInt(color.substr(1, 2), 16), g = parseInt(color.substr(3, 2), 16), b = parseInt(color.substr(5, 2), 16);

            if (r > 200 && g < 100 && b < 100) {
                resultDiv.innerHTML = `<p class="error-text">Error: A red color is reserved for the Center of Mass. Please choose a different color for Mass ${group.id.split('-')[2]}.</p>`;
                valid = false; isColorError = true; return;
            }
            if (isNaN(mass) || isNaN(x) || isNaN(y) || isNaN(z) || mass < 0) { valid = false; return; }
            
            totalMass += mass; mx += mass * x; my += mass * y; mz += mass * z;
            massesData.push({ m: mass, x, y, z, color });
        });
        
        if (!valid && !isColorError) { resultDiv.innerHTML = `<p class="error-text">Error: Please fill all fields with valid numbers (mass cannot be negative).</p>`; updateSimulation([], null); return; }
        if (!valid && isColorError) { return; }
        if (totalMass === 0) { resultDiv.innerHTML = `<p class="warning-text">Warning: Total mass is zero. Center of mass is undefined.</p>`; updateSimulation(massesData, null); return; }

        const comX = mx / totalMass, comY = my / totalMass, comZ = mz / totalMass;
        resultDiv.innerHTML = `<p><strong style="color:var(--tab-active-color)">Total Mass:</strong> ${totalMass.toFixed(4)} kg</p><p class="mt-2"><strong style="color:var(--tab-active-color)">Center of Mass (X,Y,Z):</strong></p><p class="font-mono text-lg mt-1 com-result-text">(${comX.toFixed(4)}, ${comY.toFixed(4)}, ${comZ.toFixed(4)}) m</p>`;
        updateSimulation(massesData, { x: comX, y: comY, z: comZ });
    }
    
    function resetNumerical() { document.getElementById('numerical-inputs').innerHTML = ''; massInputCount = 0; document.getElementById('numerical-result').innerHTML = 'Your numerical result will appear here.'; updateSimulation([], null); }

    let scene, camera, renderer, controls, gridHelper;
    const simContainer = document.getElementById('simulation-container');
    let massObjects = []; 
    let scene2, camera2, renderer2; // For axis helper

    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(); // Initialize background
        camera = new THREE.PerspectiveCamera(75, simContainer.clientWidth / simContainer.clientHeight, 0.1, 1000);
        camera.up.set(0, 0, 1); // Set Z as the up-axis
        camera.position.set(10, 15, 10);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(simContainer.clientWidth, simContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        simContainer.appendChild(renderer.domElement);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5); directionalLight.position.set(20, 30, 10); scene.add(directionalLight);
        controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.dampingFactor = 0.05;

        // --- Create Custom Scalable Axes ---
        const axisLength = 25;
        const axisRadius = 0.03;
        const coneRadius = axisRadius * 3;
        const coneHeight = axisRadius * 8;
        const axesGroup = new THREE.Group();

        // X-Axis (Red)
        const xAxisMat = new THREE.MeshBasicMaterial({ color: 0xdc2626 });
        const xAxisGeo = new THREE.CylinderGeometry(axisRadius, axisRadius, axisLength, 8);
        const xAxisMesh = new THREE.Mesh(xAxisGeo, xAxisMat);
        const xConeGeo = new THREE.ConeGeometry(coneRadius, coneHeight, 8);
        const xConeMesh = new THREE.Mesh(xConeGeo, xAxisMat);
        xAxisMesh.rotation.z = -Math.PI / 2;
        xAxisMesh.position.x = axisLength / 2;
        xConeMesh.rotation.z = -Math.PI / 2;
        xConeMesh.position.x = axisLength;
        axesGroup.add(xAxisMesh, xConeMesh);

        // Y-Axis (Green)
        const yAxisMat = new THREE.MeshBasicMaterial({ color: 0x22c55e });
        const yAxisGeo = new THREE.CylinderGeometry(axisRadius, axisRadius, axisLength, 8);
        const yAxisMesh = new THREE.Mesh(yAxisGeo, yAxisMat);
        const yConeGeo = new THREE.ConeGeometry(coneRadius, coneHeight, 8);
        const yConeMesh = new THREE.Mesh(yConeGeo, yAxisMat);
        yAxisMesh.position.y = axisLength / 2;
        yConeMesh.position.y = axisLength;
        axesGroup.add(yAxisMesh, yConeMesh);

        // Z-Axis (Blue)
        const zAxisMat = new THREE.MeshBasicMaterial({ color: 0x3b82f6 });
        const zAxisGeo = new THREE.CylinderGeometry(axisRadius, axisRadius, axisLength, 8);
        const zAxisMesh = new THREE.Mesh(zAxisGeo, zAxisMat);
        const zConeGeo = new THREE.ConeGeometry(coneRadius, coneHeight, 8);
        const zConeMesh = new THREE.Mesh(zConeGeo, zAxisMat);
        zAxisMesh.rotation.x = Math.PI / 2;
        zAxisMesh.position.z = axisLength / 2;
        zConeMesh.rotation.x = Math.PI / 2;
        zConeMesh.position.z = axisLength;
        axesGroup.add(zAxisMesh, zConeMesh);

        scene.add(axesGroup);
        // --- End Custom Axes ---


        // --- Axis Helper in Corner ---
        const axisContainer = document.getElementById('axis-helper-container');
        renderer2 = new THREE.WebGLRenderer({ antialias: true, alpha: true }); // alpha: true for transparent background
        renderer2.setSize(axisContainer.clientWidth, axisContainer.clientHeight);
        renderer2.setPixelRatio(window.devicePixelRatio);
        axisContainer.appendChild(renderer2.domElement);

        scene2 = new THREE.Scene();
        camera2 = new THREE.PerspectiveCamera(50, axisContainer.clientWidth / axisContainer.clientHeight, 0.1, 100);
        camera2.up.copy(camera.up); 
        camera2.position.set(0, 0, 10);

        const cornerAxesHelper = new THREE.AxesHelper(5);
        scene2.add(cornerAxesHelper);
        const ambientLight2 = new THREE.AmbientLight(0xffffff, 3);
        scene2.add(ambientLight2);

        window.addEventListener('resize', () => { 
            // Main viewport
            camera.aspect = simContainer.clientWidth / simContainer.clientHeight; 
            camera.updateProjectionMatrix(); 
            renderer.setSize(simContainer.clientWidth, simContainer.clientHeight); 
            // Corner viewport
            camera2.aspect = axisContainer.clientWidth / axisContainer.clientHeight;
            camera2.updateProjectionMatrix();
            renderer2.setSize(axisContainer.clientWidth, axisContainer.clientHeight);
        });
        animate();
    }
    function animate() { 
        requestAnimationFrame(animate); 
        controls.update(); 
        
        // Sync corner camera with main camera's rotation
        camera2.quaternion.copy(camera.quaternion);

        renderer.render(scene, camera); 
        renderer2.render(scene2, camera2);
    }

    function updateSimulation(massesData, com) {
        massObjects.forEach(obj => scene.remove(obj)); massObjects = [];
        massesData.forEach(mass => {
            const radius = Math.cbrt(mass.m) * 0.4 + 0.1; 
            const geometry = new THREE.SphereGeometry(radius, 32, 16);
            const material = new THREE.MeshStandardMaterial({ color: mass.color, metalness: 0.5, roughness: 0.3, transparent: true, opacity: 0.75 });
            const sphere = new THREE.Mesh(geometry, material); sphere.position.set(mass.x, mass.y, mass.z);
            scene.add(sphere); massObjects.push(sphere);
        });
        if (com) {
            const comGeometry = new THREE.SphereGeometry(0.3, 32, 16);
            const comMaterial = new THREE.MeshStandardMaterial({ color: 0xdc2626, emissive: 0x8f1717, metalness: 0.2, roughness: 0.2 });
            const comSphere = new THREE.Mesh(comGeometry, comMaterial); comSphere.position.set(com.x, com.y, com.z);
            scene.add(comSphere); massObjects.push(comSphere);
        }
    }
    
    function setTheme(theme) {
        document.body.classList.toggle('light-theme', theme === 'light');
        document.body.classList.toggle('dark-theme-gradient', theme === 'dark');
        localStorage.setItem('theme', theme);
        if (scene) {
            scene.background.set(theme === 'light' ? 0xf3f4f6 : 0x111827);
            if (gridHelper) scene.remove(gridHelper);
            gridHelper = new THREE.GridHelper(50, 50, theme === 'light' ? 0xcccccc : 0x444444, theme === 'light' ? 0xe0e0e0 : 0x222222);
            gridHelper.rotation.x = Math.PI / 2; // Orient grid on XY plane
            scene.add(gridHelper);
        }
    }
    document.getElementById('theme-light-btn').addEventListener('click', () => setTheme('light'));
    document.getElementById('theme-dark-btn').addEventListener('click', () => setTheme('dark'));

    window.onload = () => {
        // Initialize 3D scene first while the container has dimensions
        init3D();
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);
        // Set up the default state
        addMassInput(10, 5, 2, 3, '#3b82f6');
        addMassInput(20, -5, -4, 1, '#16a34a');
        calculateNumerical();
        // NOW, set the initial tab view to symbolic, which will hide the panel.
        showTab('symbolic');
    };
</script>

</body>
</html>